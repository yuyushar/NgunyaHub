const resto = {
  "sate-madura": {
    info: {
      name: "RESTO SATE KHAS MADURA",
      bgImage:
        "https://images.unsplash.com/photo-1620088676099-c709b5838922?w=600&auto=format&fit=crop&q=60",
      closeTime: "21:00",
      distance: "10 Menit",
      isOpen: true,
    },
    menu: [
      {
        id: 101,
        category: "food",
        name: "Nasi Goreng Sate Kambing Jumbo",
        desc: "AKU CINTA NASI GORENGGGGGGGG, ini yang orang ucapkan setelah makan nasi goreng + sate kambing ini",
        price: 40000,
        originalPrice: 50000,
        likes: 7,
        image:
          "https://images.unsplash.com/photo-1603133872878-684f208fb84b?auto=format&fit=crop&w=400&q=80",
      },
      {
        id: 102,
        category: "food",
        name: "Sate Ayam Madura",
        desc: "10 tusuk sate bumbu kacang + Lontong.",
        price: 35000,
        originalPrice: null,
        likes: 12,
        image:
          "https://images.unsplash.com/photo-1645696301019-35adcc18fc21?w=600&auto=format&fit=crop&q=60",
      },
      {
        id: 103,
        category: "drink",
        name: "Es Teh Manis",
        desc: "Teh manis segar.",
        price: 5000,
        originalPrice: null,
        likes: 100,
        image:
          "https://images.unsplash.com/photo-1556679343-c7306c1976bc?auto=format&fit=crop&w=400&q=80",
      },
      {
        id: 104,
        category: "drink",
        name: "Es Jeruk Murni",
        desc: "Jeruk peras asli tanpa gula biang.",
        price: 8000,
        originalPrice: null,
        likes: 5,
        image:
          "https://images.unsplash.com/photo-1613478223719-2ab802602423?auto=format&fit=crop&w=400&q=80",
      },
    ],
  },
  "bakso-cakman": {
    info: {
      name: "BAKSO CAK MAN",
      bgImage:
        "https://media.istockphoto.com/id/1146015549/id/foto/bakso-indonesian-meatball.jpg?s=612x612&w=0&k=20&c=eCJF5PaQfS1SP0-dZbqHbXgwDR5-gqzV_QLEKtGNeeU=",
      closeTime: "22:00",
      distance: "15 Menit",
      isOpen: true,
    },
    menu: [
      {
        id: 201,
        category: "food",
        name: "Bakso Urat Besar",
        desc: "1 Bakso urat besar + 3 bakso halus + mie.",
        price: 25000,
        originalPrice: null,
        likes: 45,
        image:
          "https://media.istockphoto.com/id/1146015549/id/foto/bakso-indonesian-meatball.jpg?s=612x612&w=0&k=20&c=eCJF5PaQfS1SP0-dZbqHbXgwDR5-gqzV_QLEKtGNeeU=",
      },
      {
        id: 202,
        category: "food",
        name: "Mie Ayam Bakso",
        desc: "Puncak tahta makanan, MIE AYAMMMM. Mie ayam + bakso. bisa request bakso (Telur/Urat/Halus)",
        price: 20000,
        originalPrice: 25000,
        likes: 30,
        image:
          "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQnp-OTgS8v6JnRsGR65ETaJlsbYC4W4ALGNw&s",
      },
      {
        id: 203,
        category: "drink",
        name: "Es Teh Manis",
        desc: "Teh manis segar.",
        price: 5000,
        originalPrice: null,
        likes: 100,
        image:
          "https://images.unsplash.com/photo-1556679343-c7306c1976bc?auto=format&fit=crop&w=400&q=80",
      },
      {
        id: 204,
        category: "drink",
        name: "Es Jeruk Murni",
        desc: "Jeruk peras asli tanpa gula biang.",
        price: 8000,
        originalPrice: null,
        likes: 5,
        image:
          "https://images.unsplash.com/photo-1613478223719-2ab802602423?auto=format&fit=crop&w=400&q=80",
      },
    ],
  },
  "seafood-maknyoss": {
    info: {
      name: "SEAFOOD MAK NYOSS",
      bgImage:
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSKKPUXij7vJWGumTq393-esrSzw9xyXuU4Jg&s",
      closeTime: "23:00",
      distance: "25 Menit",
      isOpen: false,
    },
    menu: [
      {
        id: 301,
        category: "food",
        name: "Kepiting Saos Padang",
        desc: "1 Ekor kepiting telur saos padang pedas.",
        price: 150000,
        originalPrice: 180000,
        likes: 88,
        image:
          "https://cnc-magazine.oramiland.com/parenting/original_images/Resep_Kepiting_Bumbu_Saus_Padang.jpg",
      },
      {
        id: 302,
        category: "food",
        name: "Cumi Goreng Tepung",
        desc: "CUMI CUMI GORENG PALING CRISPY DIKOTA INI! cumi goreng tepung + custom sauce(Pedas/Manis/Asam)",
        price: 45000,
        originalPrice: null,
        likes: 50,
        image:
          "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQBKVSQPkZ_xvfI29DkLh7tVlAUOSVnOPxjbg&s",
      },
      {
        id: 303,
        category: "drink",
        name: "Es Teh Manis",
        desc: "Teh manis segar.",
        price: 5000,
        originalPrice: null,
        likes: 100,
        image:
          "https://images.unsplash.com/photo-1556679343-c7306c1976bc?auto=format&fit=crop&w=400&q=80",
      },
      {
        id: 304,
        category: "drink",
        name: "Es Jeruk Murni",
        desc: "Jeruk peras asli tanpa gula biang.",
        price: 8000,
        originalPrice: null,
        likes: 5,
        image:
          "https://images.unsplash.com/photo-1613478223719-2ab802602423?auto=format&fit=crop&w=400&q=80",
      },
      {
        id: 303,
        category: "drink",
        name: "Kelapa Muda Utuh",
        desc: "Kelapa muda segar utuh.",
        price: 15000,
        originalPrice: null,
        likes: 20,
        image:
          "https://images.unsplash.com/photo-1525385133512-2f3bdd039054?auto=format&fit=crop&w=400&q=80",
      },
    ],
  },
  "siomay-pak-gyat": {
    info: {
      name: "SIOMAY & BATAGOR PAK GYAT",
      bgImage:
        "https://cdn0-production-images-kly.akamaized.net/ineYGN1ofC14lFFtuE5QVnjmxW8=/1200x675/smart/filters:quality(75):strip_icc():format(jpeg)/kly-media-production/medias/2834715/original/082188900_1561183059-shutterstock_1134726890.jpg",
      closeTime: "20:00",
      distance: "60 Menit",
      isOpen: true,
    },
    menu: [
      {
        id: 401,
        category: "food",
        name: "Siomay Campur Komplit",
        desc: "Isi siomay, tahu, kentang, pare, kol, telur. Bumbu kacang medok.",
        price: 15000,
        originalPrice: null,
        likes: 120,
        image:
          "https://lelogama.go-jek.com/files/gofood/siomay%20setan%20pedas%20mampus.jpg",
      },
      {
        id: 402,
        category: "food",
        name: "Batagor Kering",
        desc: "Batagor digoreng garing dadakan. Kriuk maksimal.",
        price: 15000,
        originalPrice: 18000,
        likes: 95,
        image:
          "https://awsimages.detik.net.id/community/media/visual/2022/01/24/food-spot-batagor-9.jpeg?w=650&q=90",
      },
      {
        id: 403,
        category: "food",
        name: "Siomay Kuah",
        desc: "Varian baru! Siomay dengan kuah kaldu ayam gurih.",
        price: 17000,
        originalPrice: null,
        likes: 30,
        image:
          "https://i0.wp.com/resepkoki.id/wp-content/uploads/2016/04/Resep-Siomay-Kuah.jpg?fit=1265%2C1216&ssl=1",
      },
      {
        id: 404,
        category: "drink",
        name: "Es Teh Kampul",
        desc: "Es teh khas Solo dengan irisan jeruk nipis.",
        price: 4000,
        originalPrice: null,
        likes: 200,
        image:
          "https://media.zcreators.id/crop/0x0:0x0/x/photo/indizone/2022/09/28/vWsnbzy/nangis-banget-cewek-ini-syok-beli-es-teh-tawar-harga-rp150-ribu-rasanya-b-aja23.jpg",
      },
      {
        id: 405,
        category: "drink",
        name: "Es Jeruk Peras",
        desc: "Segar dan bervitamin C.",
        price: 6000,
        originalPrice: null,
        likes: 45,
        image:
          "https://images.unsplash.com/photo-1613478223719-2ab802602423?auto=format&fit=crop&w=400&q=80",
      },
      {
        id: 406,
        category: "drink",
        name: "Air Mineral",
        desc: "Air putih dingin/biasa.",
        price: 3000,
        originalPrice: null,
        likes: 10,
        image:
          "https://images.unsplash.com/photo-1548839140-29a749e1cf4d?auto=format&fit=crop&w=400&q=80",
      },
    ],
  },
  "mie-gacoan": {
    info: {
      name: "MIE GACOAN CAB. PABELAN",
      bgImage:
        "https://image.popbela.com/post/20241210/9bff6f365056ea93b5c1cba4db1658c8.png",
      closeTime: "23:00",
      distance: "5 Menit",
      isOpen: true,
    },
    menu: [
      {
        id: 501,
        category: "food",
        name: "Mie Gacoan (Iblis)",
        desc: "Mie pedas manis dengan pangsit goreng. Level 1-8.",
        price: 11000,
        originalPrice: null,
        likes: 1500,
        image:
          "https://image.idntimes.com/post/20230202/327087876-728822605274628-8936677510746795867-n-08bb9dfacb5f1af6cf1542d92ddc72cc.jpg",
      },
      {
        id: 502,
        category: "food",
        name: "Mie Hompimpa (Setan)",
        desc: "Mie pedas asin gurih tanpa kecap manis. Level 1-8.",
        price: 11000,
        originalPrice: null,
        likes: 1200,
        image:
          "https://images.tokopedia.net/img/JFrBQq/2024/3/18/972c5709-902a-4423-a414-fa167a71a197.png",
      },
      {
        id: 503,
        category: "food",
        name: "Udang Keju",
        desc: "Dimsum udang isi keju lumer. Isi 3 pcs.",
        price: 10000,
        originalPrice: 12000,
        likes: 800,
        image:
          "https://buckets.sasa.co.id/v1/AUTH_Assets/Assets/p/website/medias/page_medias/resep_udang_keju_gacoan.jpg",
      },
      {
        id: 504,
        category: "drink",
        name: "Es Teh Kampul",
        desc: "Es teh khas Solo dengan irisan jeruk nipis.",
        price: 4000,
        originalPrice: null,
        likes: 200,
        image:
          "https://media.zcreators.id/crop/0x0:0x0/x/photo/indizone/2022/09/28/vWsnbzy/nangis-banget-cewek-ini-syok-beli-es-teh-tawar-harga-rp150-ribu-rasanya-b-aja23.jpg",
      },
      {
        id: 505,
        category: "drink",
        name: "Es Jeruk Peras",
        desc: "Segar dan bervitamin C.",
        price: 6000,
        originalPrice: null,
        likes: 45,
        image:
          "https://images.unsplash.com/photo-1613478223719-2ab802602423?auto=format&fit=crop&w=400&q=80",
      },
      {
        id: 506,
        category: "drink",
        name: "Air Mineral",
        desc: "Air putih dingin/biasa.",
        price: 3000,
        originalPrice: null,
        likes: 10,
        image:
          "https://images.unsplash.com/photo-1548839140-29a749e1cf4d?auto=format&fit=crop&w=400&q=80",
      },
    ],
  },
  "geprek-kumlot": {
    info: {
      name: "AYAM GEPREK KUMLOT",
      bgImage:
        "https://asset-2.tribunnews.com/travel/foto/bank/images/ilustrasi-ayam-geprek-di-solo.jpg",
      closeTime: "21:30",
      distance: "5 Menit",
      isOpen: true,
    },
    menu: [
      {
        id: 601,
        category: "food",
        name: "Paket Geprek Original",
        desc: "Nasi + Ayam Geprek + Lalapan. Sambal pedas nampol.",
        price: 13000,
        originalPrice: 15000,
        likes: 560,
        image:
          "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ-kq5T0usTEJsXH2GepC1B5T9_CBMh40EgvA&s",
      },
      {
        id: 602,
        category: "food",
        name: "Paket Geprek Bakar",
        desc: "Ayam geprek yang dibakar.",
        price: 18000,
        originalPrice: null,
        likes: 340,
        image:
          "https://i.gojekapi.com/darkroom/gofood-indonesia/v2/images/uploads/24c9d832-a846-491f-b945-0d81a7b39c43_menu-item-image_1747280996976.jpg",
      },
      {
        id: 603,
        category: "food",
        name: "Jamur Crispy Geprek",
        desc: "Jamur tiram goreng tepung digeprek sambal bawang.",
        price: 10000,
        originalPrice: null,
        likes: 120,
        image:
          "https://i.gojekapi.com/darkroom/gofood-indonesia/v2/images/uploads/44a3d095-e1bb-4f46-969d-5c70633d4099_Go-Biz_20231002_113745.jpeg",
      },
      {
        id: 604,
        category: "drink",
        name: "Es Teh Jumbo",
        desc: "Es teh manis ukuran gelas jumbo.",
        price: 4000,
        originalPrice: null,
        likes: 800,
        image:
          "https://images.unsplash.com/photo-1556679343-c7306c1976bc?auto=format&fit=crop&w=400&q=80",
      },
      {
        id: 605,
        category: "drink",
        name: "Es Milo",
        desc: "Susu coklat Milo dingin kental.",
        price: 6000,
        originalPrice: null,
        likes: 150,
        image:
          "https://dcostseafood.id/wp-content/uploads/2021/12/ES-MILO-1.jpg",
      },
      {
        id: 606,
        category: "drink",
        name: "Es Nutrisari",
        desc: "Nutrisari jeruk dingin.",
        price: 4000,
        originalPrice: null,
        likes: 90,
        image:
          "https://images.unsplash.com/photo-1613478223719-2ab802602423?auto=format&fit=crop&w=400&q=80",
      },
    ],
  },
};

let menuData = [];
let currentRestoInfo = {};
const LIKE_SESSION_KEY = "ngunyahub_session_likes";
const ORDER_HISTORY_KEY = "ngunyahub_order_history";

function getRestoFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  const restoKey = urlParams.get("resto");
  if (!restoKey || !resto[restoKey]) {
    return "sate-madura";
  }
  return restoKey;
}

function initPageData() {
  const restoKey = getRestoFromUrl();
  const data = resto[restoKey];

  currentRestoInfo = data.info || {};
  const rawMenu = data.menu || [];

  let storedLikes = [];
  try {
    const rawLikes = sessionStorage.getItem(LIKE_SESSION_KEY);
    if (rawLikes) {
      storedLikes = JSON.parse(rawLikes);
    }
    if (!Array.isArray(storedLikes)) storedLikes = [];
  } catch (e) {
    storedLikes = [];
  }

  menuData = rawMenu.map((item) => {
    const isLiked = storedLikes.includes(item.id);
    return {
      ...item,
      qty: 0,
      isLiked: isLiked,
      currentLikes: isLiked ? item.likes + 1 : item.likes,
    };
  });

  updateHeaderUI();
}

function updateHeaderUI() {
  if (!currentRestoInfo.name) return;

  $(".restoNameOrder").text(currentRestoInfo.name);
  $(".sticky-resto-name").text(currentRestoInfo.name);

  $(".headerImageOrder").css(
    "background-image",
    `url('${currentRestoInfo.bgImage}')`
  );

  const infoItems = $(".infoItemOrder");
  if (infoItems.length > 0) {
    $(infoItems[0]).text(`Tutup: ${currentRestoInfo.closeTime}`);
    $(infoItems[1]).text(`${currentRestoInfo.distance} dari Lokasi`);
  }

  const statusLabel = $(".status-label");
  const orderBtn = $(".fixed-bottom .d-flex .flex-grow-1").first();

  if (currentRestoInfo.isOpen) {
    statusLabel
      .addClass("open")
      .removeClass("closed")
      .text("OPEN")
      .css("background-color", "#2ecc71");
    orderBtn
      .text("ORDER")
      .css({
        "background-color": "#C75D2C",
        cursor: "pointer",
        opacity: "1",
      })
      .attr("onclick", "processOrder()");
  } else {
    statusLabel
      .removeClass("open")
      .addClass("closed")
      .text("CLOSED")
      .css("background-color", "#e74c3c");
    orderBtn
      .text("RESTO TUTUP")
      .css({
        "background-color": "#7f8c8d",
        cursor: "not-allowed",
        opacity: "0.8",
      })
      .removeAttr("onclick");
  }
}

function formatRupiah(number) {
  return new Intl.NumberFormat("id-ID").format(number);
}

function renderMenu(items) {
  if ($("#foodListOrder").length === 0) return;

  $("#foodListOrder").empty();
  $("#drinkListOrder").empty();

  if (items.length === 0) {
    $("#foodListOrder").append(
      "<div class='p-3 text-muted text-center'>Menu tidak ditemukan</div>"
    );
    return;
  }

  const btnStyle = currentRestoInfo.isOpen
    ? ""
    : 'style="opacity: 0.3; cursor: not-allowed;" disabled';

  items.forEach((item) => {
    let promoHtml = "";
    if (item.originalPrice) {
      promoHtml = `<small class="text-decoration-line-through text-muted me-2">${formatRupiah(
        item.originalPrice
      )}</small> 
          <span class="promoBadgeOrder">Promo</span>`;
    }

    const likedClass = item.isLiked ? "is-liked" : "";
    const heartIconClass = item.isLiked ? "fas" : "far";

    const cardHtml = `
          <div class="menuCardOrder d-flex align-items-center gap-3">
              <div class="flex-shrink-0">
                  <img src="${item.image}" class="menuImgOrder" alt="${
      item.name
    }">
              </div>
  
              <div class="flex-grow-1">
                  <h5 class="menuTitleOrder fw-bold mb-1">${item.name}</h5>
                  
                  <div class="likeBadgeOrder mb-2 ${likedClass}" onclick="toggleLike(${
      item.id
    })" id="like-btn-${item.id}">
                    <i class="${heartIconClass} fa-heart" id="heart-icon-${
      item.id
    }"></i> 
                    <span id="like-count-${item.id}">${
      item.currentLikes
    }</span> suka
                  </div>
                  
                  <p class="menuDescOrder text-truncate mb-2" style="white-space: normal; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                      ${item.desc}
                  </p>
                  
                  <div class="d-flex justify-content-between align-items-end">
                      <div class="priceWrapperOrder fw-bold">
                          ${promoHtml}
                          <div class="fs-4 mt-1">Rp ${formatRupiah(
                            item.price
                          )}</div>
                      </div>

                      <div class="d-flex align-items-center gap-2 flex-shrink-0 ms-2">
                          <button class="qtyBtnOrder" onclick="changeQty(${
                            item.id
                          }, -1)" ${btnStyle}>-</button>
                          <span class="fw-bold fs-5 text-center" style="width: 25px;" id="qty-${
                            item.id
                          }">${item.qty}</span>
                          <button class="qtyBtnOrder active" onclick="changeQty(${
                            item.id
                          }, 1)" ${btnStyle}>+</button>
                      </div>
                  </div>
              </div>
          </div>
      `;

    if (item.category === "food") {
      $("#foodListOrder").append(cardHtml);
    } else {
      $("#drinkListOrder").append(cardHtml);
    }
  });

  $(".menuListOrder").show();
}

window.toggleLike = function (id) {
  const item = menuData.find((i) => i.id === id);
  if (item) {
    item.isLiked = !item.isLiked;
    item.isLiked ? item.currentLikes++ : item.currentLikes--;

    const btnElement = $(`#like-btn-${id}`);
    const iconElement = $(`#heart-icon-${id}`);
    const countElement = $(`#like-count-${id}`);

    countElement.text(item.currentLikes);

    if (item.isLiked) {
      btnElement.addClass("is-liked");
      iconElement.removeClass("far").addClass("fas");
      iconElement.addClass("heart-anim");
      setTimeout(() => {
        iconElement.removeClass("heart-anim");
      }, 400);
    } else {
      btnElement.removeClass("is-liked");
      iconElement.removeClass("fas").addClass("far");
    }
    saveLikesToSession();
  }
};

function saveLikesToSession() {
  const likedItemIds = menuData
    .filter((item) => item.isLiked)
    .map((item) => item.id);
  sessionStorage.setItem(LIKE_SESSION_KEY, JSON.stringify(likedItemIds));
}

window.changeQty = function (id, change) {
  if (!currentRestoInfo.isOpen) return;

  const item = menuData.find((i) => i.id === id);
  if (item) {
    if (item.qty + change >= 0) {
      item.qty += change;
      $(`#qty-${id}`).text(item.qty);
      calculateTotal();
    }
  }
};

function calculateTotal() {
  let total = 0;
  menuData.forEach((item) => {
    total += item.price * item.qty;
  });
  $("#grandTotalOrder").fadeOut(100, function () {
    $(this).text(formatRupiah(total)).fadeIn(100);
  });
}

window.processOrder = function () {
  if (!currentRestoInfo.isOpen) {
    alert("Restoran Tutup, tidak bisa memesan.");
    return;
  }

  const orderedItems = menuData.filter((item) => item.qty > 0);
  if (orderedItems.length === 0) {
    alert("Kamu belum memilih menu apapun!");
    return;
  }

  const totalAmount = orderedItems.reduce(
    (sum, item) => sum + item.price * item.qty,
    0
  );

  const newOrder = {
    orderId: "ORD-" + Date.now(),
    date: new Date().toISOString(),
    restoName: currentRestoInfo.name,
    items: orderedItems,
    total: totalAmount,
    status: "Sedang Disiapkan",
  };

  let orderHistory = [];
  try {
    const storedHistory = sessionStorage.getItem(ORDER_HISTORY_KEY);
    if (storedHistory) {
      orderHistory = JSON.parse(storedHistory);
    }
    if (!Array.isArray(orderHistory)) orderHistory = [];
  } catch (e) {
    orderHistory = [];
  }

  orderHistory.unshift(newOrder);
  sessionStorage.setItem(ORDER_HISTORY_KEY, JSON.stringify(orderHistory));

  menuData.forEach((item) => (item.qty = 0));
  renderMenu(menuData);
  calculateTotal();

  window.location.href = "order-list.html";
};

$(document).ready(function () {
  if (typeof $ === "undefined") {
    alert("jQuery tidak terload! Cek koneksi internet atau link script.");
    return;
  }

  initPageData();
  renderMenu(menuData);

  $(window).scroll(function () {
    if ($(this).scrollTop() > 100) {
      $(".fixed-top-nav").addClass("scrolled");
      $(".sticky-resto-name").addClass("visible");
    } else {
      $(".fixed-top-nav").removeClass("scrolled");
      $(".sticky-resto-name").removeClass("visible");
    }
  });

  $(".categoryHeaderOrder").click(function () {
    const target = $(this).data("target");
    $(target).slideToggle();
    $(this).toggleClass("collapsed");
  });

  $("#mainSearchInput").on("input", function () {
    const value = $(this).val().toLowerCase();
    const filtered = menuData.filter(
      (item) =>
        item.name.toLowerCase().indexOf(value) > -1 ||
        item.desc.toLowerCase().indexOf(value) > -1
    );
    renderMenu(filtered);

    $(".categoryHeaderOrder").removeClass("collapsed");
    $(".menuListOrder").slideDown();
  });
});
